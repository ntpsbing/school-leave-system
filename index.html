<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ‹å°å­¸ç”Ÿè«‹å‡ç³»çµ±</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5', // Indigo-600
                        'secondary': '#f97316', // Orange-600
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* ç¢ºä¿æ—¥æœŸé¸æ“‡å™¨çš„æ¨£å¼åœ¨å„ç€è¦½å™¨ä¸€è‡´ */
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(0.5);
        }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen p-4 sm:p-8">

    <div id="loadingIndicator" class="fixed inset-0 bg-gray-50 bg-opacity-75 flex items-center justify-center z-50">
        <div class="text-xl font-semibold text-primary">ç³»çµ±è¼‰å…¥ä¸­... è«‹ç¨å€™</div>
    </div>

    <div id="appContainer" class="max-w-6xl mx-auto bg-white shadow-2xl rounded-xl p-6 sm:p-10 opacity-0 transition-opacity duration-500">
        <!-- æ¨™é¡Œèˆ‡åˆ‡æ›æŒ‰éˆ• -->
        <header class="mb-8 border-b pb-4">
            <h1 class="text-3xl font-bold text-primary mb-2">
                ğŸ  å­¸ç”Ÿè«‹å‡ç³»çµ±
            </h1>
            <p class="text-gray-600">æ–¹ä¾¿å®¶é•·æäº¤è«‹å‡ç”³è«‹ï¼Œè€å¸«å³æ™‚æŸ¥çœ‹ç´€éŒ„ã€‚</p>

            <div class="mt-4 flex space-x-4">
                <button id="showFormBtn" class="px-4 py-2 text-sm font-medium rounded-lg transition duration-150"
                    onclick="switchView('form')">
                    ğŸ“ è«‹å‡ç”³è«‹ (å®¶é•·æ“ä½œ)
                </button>
                <button id="showHistoryBtn" class="px-4 py-2 text-sm font-medium rounded-lg transition duration-150"
                    onclick="switchView('history')">
                    ğŸ“‹ è«‹å‡ç´€éŒ„æŸ¥è©¢ (æ•™å¸«æ“ä½œ)
                </button>
            </div>
        </header>

        <!-- è¨Šæ¯æ¡† -->
        <div id="messageBox" class="hidden p-3 mb-4 rounded-lg text-sm font-medium" role="alert"></div>

        <!-- 1. è«‹å‡ç”³è«‹è¡¨å–® (å®¶é•·ç«¯) -->
        <div id="leaveFormView" class="view-content">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-l-4 border-secondary pl-3">è«‹å‡ç”³è«‹</h2>
            <form id="leaveForm" class="space-y-6">

                <!-- å­¸ç”ŸåŸºæœ¬è³‡æ–™ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="studentName" class="block text-sm font-medium text-gray-700 mb-1">å­¸ç”Ÿå§“å <span class="text-red-500">*</span></label>
                        <input type="text" id="studentName" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                    <div>
                        <label for="classSeat" class="block text-sm font-medium text-gray-700 mb-1">ç­ç´š / åº§è™Ÿ (ä¾‹å¦‚: 601 / 15)</label>
                        <input type="text" id="classSeat"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary"
                            placeholder="é¸å¡«ï¼Œæ–¹ä¾¿è€å¸«è¾¨è­˜">
                    </div>
                </div>

                <!-- å®¶é•·è³‡æ–™ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="parentName" class="block text-sm font-medium text-gray-700 mb-1">å®¶é•·å§“å <span class="text-red-500">*</span></label>
                        <input type="text" id="parentName" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                    <div>
                        <label for="contactPhone" class="block text-sm font-medium text-gray-700 mb-1">è¯çµ¡é›»è©±</label>
                        <input type="tel" id="contactPhone"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary"
                            placeholder="é¸å¡«">
                    </div>
                </div>

                <!-- è«‹å‡æ—¥æœŸèˆ‡å¤©æ•¸ (èµ·å§‹æ—¥/ç¯€æ•¸ èˆ‡ çµæŸæ—¥/ç¯€æ•¸ æ±ºå®šå¤©æ•¸) -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    
                    <!-- Start Date/Period Group -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">èµ·å§‹æ™‚é–“ <span class="text-red-500">*</span></label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="date" id="startDate" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                            <select id="startPeriod" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary appearance-none bg-white text-sm">
                                <option value="1">ç¬¬ 1 ç¯€</option>
                                <option value="2">ç¬¬ 2 ç¯€</option>
                                <option value="3">ç¬¬ 3 ç¯€</option>
                                <option value="4">ç¬¬ 4 ç¯€</option>
                                <option value="5">ç¬¬ 5 ç¯€</option>
                                <option value="6">ç¬¬ 6 ç¯€</option>
                                <option value="7">ç¬¬ 7 ç¯€</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- End Date/Period Group -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">çµæŸæ™‚é–“ <span class="text-red-500">*</span></label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="date" id="endDate" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                            <select id="endPeriod" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary appearance-none bg-white text-sm">
                                <option value="1">ç¬¬ 1 ç¯€</option>
                                <option value="2">ç¬¬ 2 ç¯€</option>
                                <option value="3">ç¬¬ 3 ç¯€</option>
                                <option value="4">ç¬¬ 4 ç¯€</option>
                                <option value="5">ç¬¬ 5 ç¯€</option>
                                <option value="6">ç¬¬ 6 ç¯€</option>
                                <option value="7" selected>ç¬¬ 7 ç¯€</option>
                            </select>
                        </div>
                    </div>

                    <!-- Days Display (Read-Only) -->
                    <div id="daysDisplay" class="bg-indigo-50 p-3 rounded-lg flex flex-col justify-center">
                        <label class="block text-sm font-medium text-primary mb-1">è«‹å‡å¤©æ•¸ (è‡ªå‹•è¨ˆç®—)</label>
                        <div class="flex items-end space-x-2">
                           <!-- éš±è—çš„ input æ¬„ä½ç”¨æ–¼æäº¤æ•¸æ“šï¼Œé¡¯ç¤ºæ¨£å¼è¨­ç‚º read-only æ–‡æœ¬ -->
                           <input type="text" id="days" readonly value="0"
                               class="w-20 p-0 text-lg font-bold text-primary bg-transparent border-none focus:ring-0" 
                               style="height: auto; line-height: 1.2; padding-left: 0 !important;">
                           <span class="text-sm text-primary font-semibold">å¤©</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">è¨ˆç®—ä¾æ“šï¼šèµ·å§‹ç¯€æ•¸ï½çµæŸç¯€æ•¸ (å…± 7 ç¯€)</p>
                    </div>
                </div>

                <!-- å‡åˆ¥ -->
                <div>
                    <label for="leaveType" class="block text-sm font-medium text-gray-700 mb-1">å‡åˆ¥ <span class="text-red-500">*</span></label>
                    <select id="leaveType" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary appearance-none bg-white">
                        <option value="" disabled selected>è«‹é¸æ“‡å‡åˆ¥</option>
                        <option value="ç—…å‡">ğŸ¤’ ç—…å‡</option>
                        <option value="äº‹å‡">ğŸ’¼ äº‹å‡</option>
                        <option value="å–ªå‡">ğŸ•¯ï¸ å–ªå‡</option>
                        <option value="å…¬å‡">ğŸ… å…¬å‡ (å…¬å‹™æˆ–ä»£è¡¨å­¸æ ¡)</option>
                        <option value="ç‰¹ä¼‘">â›±ï¸ ç‰¹æ®Šä¼‘å‡ (å…¶ä»–)</option>
                    </select>
                </div>

                <!-- è«‹å‡åŸå›  -->
                <div>
                    <label for="reason" class="block text-sm font-medium text-gray-700 mb-1">è«‹å‡åŸå› æè¿° <span class="text-red-500">*</span></label>
                    <textarea id="reason" rows="4" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary"></textarea>
                </div>

                <!-- æäº¤æŒ‰éˆ• -->
                <div>
                    <button type="submit"
                        class="w-full bg-primary text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md">
                        é€å‡ºè«‹å‡ç”³è«‹
                    </button>
                </div>
            </form>
        </div>

        <!-- 2. è«‹å‡ç´€éŒ„æŸ¥è©¢ (æ•™å¸«ç«¯) -->
        <div id="leaveHistoryView" class="view-content hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-l-4 border-secondary pl-3">è«‹å‡ç´€éŒ„æŸ¥è©¢</h2>
            
            <!-- ç¯©é¸å™¨ -->
            <div class="mb-4 flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                <input type="text" id="filterStudent" placeholder="ä¾å­¸ç”Ÿå§“åæˆ–åº§è™Ÿç¯©é¸..."
                    class="p-2 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary flex-grow">
                <select type="text" id="filterType"
                    class="p-2 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary appearance-none bg-white">
                    <option value="">æ‰€æœ‰å‡åˆ¥</option>
                    <option value="ç—…å‡">ç—…å‡</option>
                    <option value="äº‹å‡">äº‹å‡</option>
                    <option value="å–ªå‡">å–ªå‡</option>
                    <option value="å…¬å‡">å…¬å‡</option>
                    <option value="ç‰¹ä¼‘">ç‰¹æ®Šä¼‘å‡</option>
                </select>
            </div>

            <div class="overflow-x-auto shadow-md rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-primary/90 text-white">
                        <tr>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider">æ—¥æœŸ/ç¯€æ•¸</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider">å­¸ç”Ÿ/ç­ç´š</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider">å¤©æ•¸</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider">å‡åˆ¥</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider hidden sm:table-cell">å®¶é•·</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider">åŸå› æ‘˜è¦</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider">æäº¤æ™‚é–“</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- ç´€éŒ„å°‡ç”± JS è¼‰å…¥ -->
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                è¼‰å…¥è«‹å‡ç´€éŒ„ä¸­...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p id="noRecordsMessage" class="hidden text-center text-gray-500 mt-6">ç›®å‰æ²’æœ‰è«‹å‡ç´€éŒ„ã€‚</p>
            <p class="text-xs text-gray-400 mt-4">æ‚¨çš„ä½¿ç”¨è€… ID: <span id="currentUserId" class="font-mono text-gray-500">-</span></p>
        </div>
    </div>

    <!-- æ•™å¸«å¯†ç¢¼é©—è­‰ Modal -->
    <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4 text-primary">æ•™å¸«èº«ä»½é©—è­‰</h3>
            <p class="text-gray-600 mb-4">è«‹è¼¸å…¥å¯†ç¢¼ä»¥æŸ¥çœ‹è«‹å‡ç´€éŒ„ã€‚</p>
            <input type="password" id="teacherPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary mb-4"
                   onkeydown="if(event.key === 'Enter') checkPassword()">
            <p id="passwordError" class="text-red-500 text-sm mb-4 hidden">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚</p>
            <div class="flex justify-end space-x-3">
                <button onclick="document.getElementById('passwordModal').classList.add('hidden'); document.getElementById('teacherPassword').value = '';"
                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                    å–æ¶ˆ
                </button>
                <button onclick="checkPassword()"
                        class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-orange-700 transition duration-150">
                    é©—è­‰
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firebase å…¨åŸŸè®Šæ•¸
        window.firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, addDoc, onSnapshot, query, orderBy, setLogLevel };
    </script>

    <script>
        // è¨­å®šå…¨åŸŸè®Šæ•¸
        let db, auth, userId = null;
        let isAuthReady = false;
        let leaveRecords = []; // å„²å­˜æ‰€æœ‰è«‹å‡ç´€éŒ„

        // æ–°å¢æ•™å¸«èªè­‰ç‹€æ…‹å’Œå¯†ç¢¼
        let isTeacherAuthenticated = false;
        const TEACHER_PASSWORD = 'ntps666'; 

        const loadingIndicator = document.getElementById('loadingIndicator');
        const appContainer = document.getElementById('appContainer');
        const messageBox = document.getElementById('messageBox');

        // ---------------------------------------------------------------------
        // å¾ Canvas ç’°å¢ƒå–å¾— Firebase é…ç½®èˆ‡èªè­‰è³‡è¨Š (å·²ä¿®æ­£ç‚ºè‡ªå‹•è®€å–)
        // ---------------------------------------------------------------------
        // ç¢ºä¿åœ¨ Canvas ä¹‹å¤–ä¹Ÿèƒ½åŸ·è¡Œ (æä¾›é è¨­å€¼)
        const firebaseConfig = {
          apiKey: "AIzaSyCl-aa5JZvfjgKNCu1h1wQaQkOSkQ8GCTs",
          authDomain: "student-leave-system-97560.firebaseapp.com",
          projectId: "student-leave-system-97560",
          storageBucket: "student-leave-system-97560.firebasestorage.app",
          messagingSenderId: "670531005041",
          appId: "1:670531005041:web:4ec05a8a9c78f5b00489d0",
          measurementId: "G-9L26WH30Q7"
        };

        if (!firebaseConfig) {
            console.error("Firebase é…ç½®éºå¤±ã€‚è«‹ç¢ºä¿ç¨‹å¼ç¢¼åœ¨æ”¯æ´çš„ç’°å¢ƒä¸­é‹è¡Œæˆ–æ‰‹å‹•æä¾›é…ç½®ã€‚");
            document.getElementById('loadingIndicator').innerHTML = '<div class="text-xl font-semibold text-red-600">éŒ¯èª¤ï¼šFirebase é…ç½®éºå¤±ï¼è«‹æª¢æŸ¥ä¸»æ§å°ä¸¦æä¾›è‡ªå·±çš„é…ç½®ã€‚</div>';
            // ç”±æ–¼é…ç½®ç¼ºå¤±ï¼Œç„¡æ³•ç¹¼çºŒåŸ·è¡Œ
            // é¡¯ç¤ºéŒ¯èª¤å¾Œï¼Œä¸é€²è¡Œå¾ŒçºŒåˆå§‹åŒ–
        }
        
        const COLLECTION_PATH = `/artifacts/${appId}/public/data/leave_requests`;

        // =========================================================================
        // è¼”åŠ©å‡½æ•¸
        // =========================================================================

        /**
         * é¡¯ç¤ºè¨Šæ¯æ¡†
         * @param {string} message - è¨Šæ¯å…§å®¹
         * @param {string} type - è¨Šæ¯é¡å‹: 'success' æˆ– 'error'
         */
        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            }
            
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 8000); // å»¶é•·éŒ¯èª¤è¨Šæ¯é¡¯ç¤ºæ™‚é–“
        }

        /**
         * è¨ˆç®—è«‹å‡å¤©æ•¸ (åŒ…å«èµ·å§‹æ—¥/ç¯€æ•¸å’ŒçµæŸæ—¥/ç¯€æ•¸)
         * @param {string} startDateString - èµ·å§‹æ—¥æœŸ (YYYY-MM-DD)
         * @param {number} startPeriod - èµ·å§‹ç¯€æ•¸ (1-7)
         * @param {string} endDateString - çµæŸæ—¥æœŸ (YYYY-MM-DD)
         * @param {number} endPeriod - çµæŸç¯€æ•¸ (1-7)
         * @returns {number} ç¸½è«‹å‡å¤©æ•¸ (å°æ•¸é»å¾Œå…©ä½)
         */
        function calculateDays(startDateString, startPeriod, endDateString, endPeriod) {
            const P_TOTAL = 7;
            if (!startDateString || !endDateString) return 0;
            
            // ä½¿ç”¨ '/' æ›¿æ› '-' ä»¥ç¢ºä¿è·¨ç€è¦½å™¨å…¼å®¹æ€§
            const start = new Date(startDateString.replace(/-/g, '/'));
            const end = new Date(endDateString.replace(/-/g, '/'));
            
            if (isNaN(start.getTime()) || isNaN(end.getTime())) return 0;

            const startMs = start.getTime();
            const endMs = end.getTime();
            
            // çµæŸæ—¥æ—©æ–¼èµ·å§‹æ—¥ï¼Œæˆ–åŒä¸€å¤©çµæŸç¯€æ•¸æ—©æ–¼èµ·å§‹ç¯€æ•¸
            if (endMs < startMs) return 0;
            if (endMs === startMs && endPeriod < startPeriod) return 0;

            const dayMs = 1000 * 60 * 60 * 24;
            // è¨ˆç®—æ—¥æœŸçš„å·®ç•°ï¼ˆå¤©æ•¸ï¼‰ï¼ŒMath.round è™•ç†æ™‚å€å·®ç•°
            const diffDays = Math.round((endMs - startMs) / dayMs);

            let totalDays = 0;

            if (diffDays === 0) {
                // Case 1: Same Day
                const periodsTaken = endPeriod - startPeriod + 1;
                totalDays = periodsTaken / P_TOTAL;
            } else {
                // Case 2: Multiple Days (diffDays >= 1)
                
                // ä¸­é–“çš„å®Œæ•´å¤©æ•¸ (ä¸åŒ…å«èµ·å§‹æ—¥å’ŒçµæŸæ—¥)
                const fullDays = diffDays > 1 ? diffDays - 1 : 0;
                totalDays += fullDays;

                // èµ·å§‹æ—¥åˆ†æ•¸ (å¾ startPeriod åˆ° P7)
                // æœŸé–“æ•¸: P_TOTAL - startPeriod + 1
                const startDayPeriods = P_TOTAL - startPeriod + 1;
                totalDays += startDayPeriods / P_TOTAL;

                // çµæŸæ—¥åˆ†æ•¸ (å¾ P1 åˆ° endPeriod)
                // æœŸé–“æ•¸: endPeriod
                const endDayPeriods = endPeriod;
                totalDays += endDayPeriods / P_TOTAL;
            }

            // å››æ¨äº”å…¥åˆ°å°æ•¸é»å¾Œå…©ä½ï¼Œç¢ºä¿ç²¾ç¢ºåº¦ï¼Œä¸¦è½‰å›æ•¸å­—å‹æ…‹
            return parseFloat(totalDays.toFixed(2));
        }
        
        // -------------------------------------------------------------------------
        // UI é‚è¼¯
        // -------------------------------------------------------------------------

        /** æª¢æŸ¥æ•™å¸«å¯†ç¢¼ */
        function checkPassword() {
            const passwordInput = document.getElementById('teacherPassword');
            const passwordError = document.getElementById('passwordError');
            const enteredPassword = passwordInput.value;
            
            passwordError.classList.add('hidden'); // Reset error message

            if (enteredPassword === TEACHER_PASSWORD) {
                isTeacherAuthenticated = true;
                document.getElementById('passwordModal').classList.add('hidden');
                passwordInput.value = ''; // Clear password
                showMessage("é©—è­‰æˆåŠŸï¼æ‚¨ç¾åœ¨å¯ä»¥æŸ¥çœ‹è«‹å‡ç´€éŒ„ã€‚", 'success');
                
                // After successful login, manually switch the view
                switchView('history'); 
            } else {
                passwordError.textContent = "å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚";
                passwordError.classList.remove('hidden');
                passwordInput.value = ''; // Clear password on failure
                passwordInput.focus();
            }
        }

        /** åˆ‡æ›ä¸»è¦–åœ– */
        function switchView(view) {
            if (view === 'history' && !isTeacherAuthenticated) {
                // Intercept and show password modal
                document.getElementById('passwordModal').classList.remove('hidden');
                // æ¸…ç©ºä¸Šæ¬¡éŒ¯èª¤è¨Šæ¯å’Œå¯†ç¢¼
                document.getElementById('teacherPassword').value = '';
                document.getElementById('passwordError').classList.add('hidden');
                document.getElementById('teacherPassword').focus();
                return; // Stop switching view
            }
            
            // å¯¦éš›åˆ‡æ›è¦–åœ–
            document.querySelectorAll('.view-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('leave' + (view === 'form' ? 'FormView' : 'HistoryView')).classList.remove('hidden');

            // æŒ‰éˆ•æ¨£å¼åˆ‡æ›
            document.getElementById('showFormBtn').className = view === 'form'
                ? 'px-4 py-2 text-sm font-medium rounded-lg bg-primary text-white shadow-lg'
                : 'px-4 py-2 text-sm font-medium rounded-lg text-primary hover:bg-indigo-50 border border-primary/20';
            
            document.getElementById('showHistoryBtn').className = view === 'history'
                ? 'px-4 py-2 text-sm font-medium rounded-lg bg-primary text-white shadow-lg'
                : 'px-4 py-2 text-sm font-medium rounded-lg text-primary hover:bg-indigo-50 border border-primary/20';

            // åˆ‡æ›åˆ°æ­·å²ç´€éŒ„æ™‚ï¼Œå¼·åˆ¶è§¸ç™¼ä¸€æ¬¡ç¯©é¸/æ¸²æŸ“
            if (view === 'history') {
                renderHistoryTable();
            }
        }

        // -------------------------------------------------------------------------
        // Firebase & Auth é‚è¼¯
        // -------------------------------------------------------------------------

        /** åˆå§‹åŒ– Firebase */
        async function initializeFirebase() {
            // å¦‚æœ firebaseConfig å·²ç¶“åˆ¤æ–·ç‚º null (åœ¨é…ç½®è®€å–å€å¡Š)ï¼Œå‰‡ä¸å†å˜—è©¦åˆå§‹åŒ–
            if (!firebaseConfig) {
                // å¼·åˆ¶é¡¯ç¤ºæ‡‰ç”¨ç¨‹å¼å®¹å™¨ï¼Œå³ä½¿æ˜¯éŒ¯èª¤ç‹€æ…‹
                appContainer.classList.remove('opacity-0');
                // ç”±æ–¼é…ç½®ç¼ºå¤±ï¼Œä¸éœ€è¦é€²ä¸€æ­¥åˆå§‹åŒ–
                return;
            }

            try {
                // è¼‰å…¥ Firebase è¨­å®š
                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.getFirestore(app);
                auth = firebase.getAuth(app);
                
                // å•Ÿç”¨ Firestore Debug æ¨¡å¼ (å¯é¸)
                firebase.setLogLevel('debug');

                // æ ¹æ“šç’°å¢ƒæä¾›çš„ Token é€²è¡Œèªè­‰ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨åŒ¿åç™»å…¥ (å·²ä¿®æ­£)
                if (initialAuthToken) {
                    await firebase.signInWithCustomToken(auth, initialAuthToken);
                    console.log("ä½¿ç”¨è‡ªè¨‚ Token ç™»å…¥æˆåŠŸã€‚");
                } else {
                    await firebase.signInAnonymously(auth);
                    console.log("ä½¿ç”¨åŒ¿åç™»å…¥æˆåŠŸã€‚");
                }
                
                firebase.onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('currentUserId').textContent = userId;
                        isAuthReady = true;
                        // èªè­‰å®Œæˆå¾Œï¼Œé–‹å§‹ç›£è½è³‡æ–™
                        listenForLeaveRequests();
                    } else {
                        userId = null;
                        document.getElementById('currentUserId').textContent = 'æœªç™»å…¥';
                        isAuthReady = true;
                    }
                    loadingIndicator.classList.add('hidden');
                    appContainer.classList.remove('opacity-0');
                    switchView('form'); // é è¨­é¡¯ç¤ºè«‹å‡è¡¨å–®
                });

            } catch (error) {
                // ä¿®æ­£ï¼šç•¶ Firebase åˆå§‹åŒ–æˆ–èªè­‰å¤±æ•—æ™‚ï¼Œä¹Ÿè¦ç§»é™¤è¼‰å…¥ç•«é¢ä¸¦é¡¯ç¤ºéŒ¯èª¤
                console.error("Firebase åˆå§‹åŒ–å¤±æ•— (è«‹æª¢æŸ¥é…ç½®èˆ‡é©—è­‰è¦å‰‡):", error);
                loadingIndicator.classList.add('hidden');
                appContainer.classList.remove('opacity-0'); // é¡¯ç¤ºæ‡‰ç”¨ç¨‹å¼ä»‹é¢
                showMessage(`ç³»çµ±åˆå§‹åŒ–éŒ¯èª¤ï¼šèªè­‰å¤±æ•—ã€‚éŒ¯èª¤ç¢¼ï¼š${error.code || 'UNKNOWN'}ã€‚è«‹æª¢æŸ¥ä¸»æ§å°ä¸¦ç¢ºèªæ‚¨çš„ Firebase é…ç½®å’Œèªè­‰/è¦å‰‡è¨­å®šã€‚`, 'error');
            }
        }

        /** ç›£è½è«‹å‡ç´€éŒ„ (æ•™å¸«ç«¯) */
        function listenForLeaveRequests() {
            if (!isAuthReady || !db) return;

            const q = firebase.query(firebase.collection(db, COLLECTION_PATH));
            
            // ä½¿ç”¨ onSnapshot ç›£è½å³æ™‚æ›´æ–°
            firebase.onSnapshot(q, (snapshot) => {
                leaveRecords = [];
                snapshot.forEach((doc) => {
                    // å°‡è³‡æ–™èˆ‡æ–‡ä»¶ ID å­˜å…¥é™£åˆ—
                    leaveRecords.push({ id: doc.id, ...doc.data() });
                });
                // å°‡ç´€éŒ„æŒ‰æäº¤æ™‚é–“å€’åºæ’åˆ— (æ³¨æ„ï¼šFirestore å»ºè­°åœ¨ä¼ºæœå™¨ç«¯æ’åºï¼Œä½†é€™è£¡ç‚ºäº†ç°¡åŒ–ä»ä½¿ç”¨å®¢æˆ¶ç«¯æ’åº)
                // ç”±æ–¼ Firestore çš„ timestamp æ˜¯ä¸€å€‹ç‰©ä»¶ï¼Œæˆ‘å€‘éœ€è¦ä½¿ç”¨ toDate() è½‰æ›
                leaveRecords.sort((a, b) => {
                    const dateA = a.timestamp && a.timestamp.toDate ? a.timestamp.toDate().getTime() : 0;
                    const dateB = b.timestamp && b.timestamp.toDate ? b.timestamp.toDate().getTime() : 0;
                    return dateB - dateA; // å€’åº
                });
                
                // é‡æ–°æ¸²æŸ“è¡¨æ ¼
                renderHistoryTable();
            }, (error) => {
                console.error("ç›£è½è«‹å‡ç´€éŒ„å¤±æ•—:", error);
                showMessage("ç„¡æ³•è¼‰å…¥ç´€éŒ„ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–è³‡æ–™åº«è¦å‰‡ã€‚", 'error');
            });
        }
        
        // -------------------------------------------------------------------------
        // è«‹å‡è¡¨å–®é‚è¼¯ (å®¶é•·ç«¯)
        // -------------------------------------------------------------------------
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();

            const leaveForm = document.getElementById('leaveForm');
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate'); 
            const startPeriodInput = document.getElementById('startPeriod');
            const endPeriodInput = document.getElementById('endPeriod');
            const daysInput = document.getElementById('days');
            
            // é è¨­æ—¥æœŸç‚ºä»Šå¤©
            const today = new Date().toISOString().split('T')[0];
            
            startDateInput.value = today;
            endDateInput.value = today; // é è¨­çµæŸæ—¥æœŸç‚ºèµ·å§‹æ—¥æœŸ
            startPeriodInput.value = "1"; // é è¨­èµ·å§‹ç¯€æ•¸ç‚º 1
            endPeriodInput.value = "7";   // é è¨­çµæŸç¯€æ•¸ç‚º 7
            
            // ç›£è½æ—¥æœŸå’Œç¯€æ•¸è®ŠåŒ–ï¼Œæ›´æ–°å¤©æ•¸é¡¯ç¤º
            function updateDays() {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                const startPeriod = parseInt(startPeriodInput.value);
                const endPeriod = parseInt(endPeriodInput.value);
                
                let calculatedDays = calculateDays(startDate, startPeriod, endDate, endPeriod);
                
                daysInput.value = calculatedDays;
                
                // è™•ç†æ—¥æœŸ/ç¯€æ•¸éŒ¯èª¤çš„æƒ…æ³
                const start = new Date(startDate.replace(/-/g, '/'));
                const end = new Date(endDate.replace(/-/g, '/'));

                if (end.getTime() < start.getTime()) {
                    // çµæŸæ—¥æœŸæ—©æ–¼èµ·å§‹æ—¥æœŸ
                    showMessage("çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼èµ·å§‹æ—¥æœŸï¼Œå·²è‡ªå‹•ä¿®æ­£çµæŸæ—¥æœŸã€‚", 'error');
                    endDateInput.value = startDate; // å¼·åˆ¶è¨­å®šçµæŸæ—¥ç‚ºèµ·å§‹æ—¥
                    // é‡æ–°è¨ˆç®—ï¼Œä½¿ç”¨ä¿®æ­£å¾Œçš„æ—¥æœŸ
                    calculatedDays = calculateDays(startDate, startPeriod, startDate, endPeriod);
                    daysInput.value = calculatedDays;
                } else if (end.getTime() === start.getTime() && endPeriod < startPeriod) {
                    // åŒä¸€å¤©å…§ï¼ŒçµæŸç¯€æ•¸æ—©æ–¼èµ·å§‹ç¯€æ•¸
                    showMessage("åŒä¸€å¤©å…§ï¼ŒçµæŸç¯€æ•¸ä¸èƒ½æ—©æ–¼èµ·å§‹ç¯€æ•¸ï¼Œå·²è‡ªå‹•ä¿®æ­£çµæŸç¯€æ•¸ã€‚", 'error');
                    endPeriodInput.value = startPeriodInput.value; // å¼·åˆ¶è¨­å®šçµæŸç¯€æ•¸ç‚ºèµ·å§‹ç¯€æ•¸
                    // é‡æ–°è¨ˆç®—
                    calculatedDays = calculateDays(startDate, startPeriod, endDate, startPeriod);
                    daysInput.value = calculatedDays;
                } else if (calculatedDays <= 0 && startDate && endDate) {
                    // é›–ç„¶æ—¥æœŸé‚è¼¯å·²ä¿®æ­£ï¼Œä½†å¦‚æœè¨ˆç®—çµæœä»ç‚º 0 æˆ–æ›´å°ï¼Œå‰‡é¡¯ç¤º 0
                    daysInput.value = 0;
                }
            }

            // è¨»å†Šæ‰€æœ‰ç›¸é—œè¼¸å…¥æ¬„ä½çš„äº‹ä»¶ç›£è½å™¨
            startDateInput.addEventListener('change', updateDays);
            endDateInput.addEventListener('change', updateDays); 
            startPeriodInput.addEventListener('change', updateDays);
            endPeriodInput.addEventListener('change', updateDays);
            
            updateDays(); // åˆå§‹è¼‰å…¥æ™‚è¨ˆç®—ä¸€æ¬¡

            leaveForm.addEventListener('submit', handleFormSubmit);
        });
        
        /** è™•ç†è¡¨å–®æäº¤ */
        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!isAuthReady || !db) {
                showMessage("ç³»çµ±ä»åœ¨åˆå§‹åŒ–ä¸­ï¼Œè«‹ç¨å€™å†è©¦ã€‚", 'error');
                return;
            }

            const studentName = document.getElementById('studentName').value.trim();
            const parentName = document.getElementById('parentName').value.trim();
            const classSeat = document.getElementById('classSeat').value.trim();
            const contactPhone = document.getElementById('contactPhone').value.trim();
            const startDate = document.getElementById('startDate').value;
            const startPeriod = parseInt(document.getElementById('startPeriod').value);
            const endDate = document.getElementById('endDate').value;
            const endPeriod = parseInt(document.getElementById('endPeriod').value);
            
            // å†æ¬¡è¨ˆç®—å¤©æ•¸ï¼Œç¢ºä¿æäº¤çš„å€¼æ˜¯æœ€çµ‚æ­£ç¢ºçš„å€¼
            const days = calculateDays(startDate, startPeriod, endDate, endPeriod);
            const leaveType = document.getElementById('leaveType').value;
            const reason = document.getElementById('reason').value.trim();
            
            // é©—è­‰
            if (!studentName || !parentName || !startDate || !endDate || days <= 0 || !leaveType || !reason) {
                showMessage("è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ä¸¦ç¢ºä¿è«‹å‡å¤©æ•¸å¤§æ–¼é›¶ã€‚", 'error');
                return;
            }

            // å†æ¬¡é©—è­‰æ—¥æœŸ/ç¯€æ•¸é‚è¼¯
            const start = new Date(startDate.replace(/-/g, '/'));
            const end = new Date(endDate.replace(/-/g, '/'));
            if (end.getTime() < start.getTime() || (end.getTime() === start.getTime() && endPeriod < startPeriod)) {
                 showMessage("æ—¥æœŸæˆ–ç¯€æ•¸é¸æ“‡ç¯„åœç„¡æ•ˆï¼Œè«‹æª¢æŸ¥èµ·å§‹æ™‚é–“æ˜¯å¦æ™šæ–¼çµæŸæ™‚é–“ã€‚", 'error');
                 return;
            }


            const leaveData = {
                studentName,
                parentName,
                classSeat: classSeat || 'N/A',
                contactPhone: contactPhone || 'N/A',
                startDate,
                startPeriod, 
                endDate,
                endPeriod, 
                days, 
                type: leaveType,
                reason,
                submitterId: userId,
                timestamp: new Date(),
            };

            try {
                // å°‡è«‹å‡è³‡æ–™å¯«å…¥ Firestore
                await firebase.addDoc(firebase.collection(db, COLLECTION_PATH), leaveData);
                
                showMessage(`âœ… æäº¤æˆåŠŸï¼å·²ç‚º ${studentName} æäº¤ ${days} å¤©çš„ ${leaveType} ç”³è«‹ã€‚`);
                leaveForm.reset(); // æ¸…ç©ºè¡¨å–®
                
                // é‡è¨­æ—¥æœŸ/ç¯€æ•¸ç‚ºä»Šå¤© P1-P7ï¼Œä¸¦é‡æ–°è¨ˆç®—å¤©æ•¸ (1å¤©)
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('startDate').value = today; 
                document.getElementById('endDate').value = today;
                document.getElementById('startPeriod').value = "1"; 
                document.getElementById('endPeriod').value = "7";
                document.getElementById('days').value = 1;

            } catch (error) {
                console.error("æäº¤è«‹å‡ç”³è«‹å¤±æ•—:", error);
                showMessage("æäº¤å¤±æ•—ï¼šç¶²è·¯éŒ¯èª¤æˆ–è³‡æ–™åº«å•é¡Œã€‚", 'error');
            }
        }
        
        // -------------------------------------------------------------------------
        // ç´€éŒ„æŸ¥è©¢é‚è¼¯ (æ•™å¸«ç«¯)
        // -------------------------------------------------------------------------

        const filterStudentInput = document.getElementById('filterStudent');
        const filterTypeSelect = document.getElementById('filterType');

        filterStudentInput.addEventListener('input', renderHistoryTable);
        filterTypeSelect.addEventListener('change', renderHistoryTable);

        /**
         * æ¸²æŸ“è«‹å‡ç´€éŒ„è¡¨æ ¼
         */
        function renderHistoryTable() {
            const tbody = document.getElementById('historyTableBody');
            const noRecordsMessage = document.getElementById('noRecordsMessage');
            
            const studentFilter = filterStudentInput.value.toLowerCase();
            const typeFilter = filterTypeSelect.value;

            // 1. éæ¿¾è³‡æ–™
            const filteredRecords = leaveRecords.filter(record => {
                const studentMatch = record.studentName.toLowerCase().includes(studentFilter) || 
                                     record.classSeat.toLowerCase().includes(studentFilter);
                const typeMatch = !typeFilter || record.type === typeFilter;
                return studentMatch && typeMatch;
            });
            
            // 2. è™•ç†ç„¡ç´€éŒ„æƒ…æ³
            if (filteredRecords.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                            ${leaveRecords.length === 0 ? 'ç›®å‰æ²’æœ‰è«‹å‡ç´€éŒ„ã€‚' : 'ç„¡ç¬¦åˆç¯©é¸æ¢ä»¶çš„ç´€éŒ„ã€‚'}
                        </td>
                    </tr>`;
                noRecordsMessage.classList.toggle('hidden', leaveRecords.length > 0);
                return;
            }

            noRecordsMessage.classList.add('hidden');

            // 3. æ¸²æŸ“è¡¨æ ¼åˆ—
            tbody.innerHTML = filteredRecords.map(record => {
                
                // é¡¯ç¤ºæ—¥æœŸå€é–“ (åŒ…å«ç¯€æ•¸è³‡è¨Š)
                const isFullDayStart = record.startPeriod == 1;
                const isFullDayEnd = record.endPeriod == 7;
                
                let dateRange;

                if (record.startDate === record.endDate) {
                    // å–®æ—¥è«‹å‡
                    if (isFullDayStart && isFullDayEnd) {
                        dateRange = record.startDate + " (å…¨æ—¥)";
                    } else {
                        dateRange = `${record.startDate} (${record.startPeriod} ~ ${record.endPeriod} ç¯€)`;
                    }
                } else {
                    // è·¨æ—¥è«‹å‡
                    const startDetail = isFullDayStart ? '' : ` (${record.startPeriod} ç¯€)`;
                    const endDetail = isFullDayEnd ? '' : ` (${record.endPeriod} ç¯€)`;
                    dateRange = `${record.startDate}${startDetail} ~ ${record.endDate}${endDetail}`;
                }

                const reasonSummary = record.reason.length > 30 ? record.reason.substring(0, 30) + '...' : record.reason;
                const submitTime = record.timestamp.toDate().toLocaleDateString('zh-TW', {
                    hour: '2-digit', minute: '2-digit', month: '2-digit', day: '2-digit'
                });
                
                // å‡åˆ¥é¡è‰²æ¨™è¨˜
                let typeColor = 'bg-gray-200 text-gray-800';
                if (record.type === 'ç—…å‡') typeColor = 'bg-red-100 text-red-700';
                else if (record.type === 'äº‹å‡') typeColor = 'bg-yellow-100 text-yellow-700';
                else if (record.type === 'å…¬å‡') typeColor = 'bg-blue-100 text-blue-700';

                return `
                    <tr class="hover:bg-gray-50 transition duration-100">
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${dateRange}</td>
                        <td class="px-3 py-3 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${record.studentName}</div>
                            <div class="text-xs text-gray-500">${record.classSeat}</div>
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900 font-semibold">${record.days} å¤©</td>
                        <td class="px-3 py-3 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${typeColor}">
                                ${record.type}
                            </span>
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">${record.parentName}</td>
                        <td class="px-3 py-3 text-sm text-gray-500 max-w-xs overflow-hidden">${reasonSummary}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-xs text-gray-400">${submitTime}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // è®“å…¨åŸŸå‡½æ•¸å¯ä»¥åœ¨ HTML æ¨™ç±¤ä¸­è¢«èª¿ç”¨
        window.switchView = switchView; 
        window.checkPassword = checkPassword;
        
    </script>
</body>
</html>
